<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Научные работы</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <!-- Buttons for DataTables -->
    <link href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css" rel="stylesheet">
</head>
<body>
        <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#" style="color: var(--primary-color);">
                <i class="bi bi-journal-bookmark-fill me-2"></i>ScienceFlow
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item mx-2">
                        <a class="nav-link active" href="./index.html">Главная</a>
                    </li>
                    <li class="nav-item mx-2">
                        <a class="nav-link" href="./index.html#about">О нас</a>
                    </li>
                    <li class="nav-item mx-2">
                        <a class="nav-link" href="./all_works.html">Все работы</a>
                    </li>
                    <li class="nav-item mx-2">
                        <a class="nav-link" href="./profile.html">Профиль</a>
                    </li>
                    <li class="nav-item mx-2">
                        <a class="nav-link" href="./statistics.html">статистика</a>
                    </li>
                    <li class="nav-item mx-2">
                        <a class="btn btn-custom" href="./register.html">Регистрация</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-5 pt-5">
        <h2>Научные работы</h2>
        
        <!-- Фильтры -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label>От:</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col-md-3">
                <label>До:</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="col-md-3">
                <label>Тип автора:</label>
                <select id="authorType" class="form-select">
                    <option value="">Все</option>
                    <option value="преподаватель">Преподаватели</option>
                    <option value="магистрант">Магистранты</option>
                    <option value="докторант">Докторанты</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary me-2" onclick="applyFilters()">Применить</button>
                <button class="btn btn-success" onclick="exportToExcel()">Экспорт в Excel</button>
            </div>
        </div>

       <table id="worksTable" class="table table-striped" style="width:100%">
            <thead>
                <tr>
                    <th>Авторы</th>
                    <th>Название работы</th>
                    <th>Категория</th>
                    <th>Рейтинг</th>
                    <th>Уникальность</th>
                </tr>
            </thead>
            <tbody>
                <!-- Данные будут загружены через API -->
            </tbody>
        </table>
    </div>

    <!-- Скрипты -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    let table;
    let allData = [];

    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await axios.get('http://127.0.0.1:8000/api/scientufic-works/');
            allData = response.data.results; // Исправлено здесь
            initializeTable(allData);
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
        }
    });

    function initializeTable(data) {
        if ($.fn.DataTable.isDataTable('#worksTable')) {
            $('#worksTable').DataTable().destroy();
        }

        table = $('#worksTable').DataTable({
            data: data,
            columns: [
                { 
                    data: 'author',
                    render: function(data) {
                        return data.join(', ');
                    }
                },
                { data: 'work_name', title: 'Название работы' }, 
                { data: 'category', title: 'Категория' },
                { data: 'work_rating', title: 'Рейтинг' },
                { data: 'uniquenes_score', title: 'Уникальность' },
                { data: 'date_of_publish', title: 'Дата публикации' }
            ],
            pageLength: 10,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/ru.json'
            }
        });
    }

    function applyFilters() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const authorType = document.getElementById('authorType').value;

        let filteredData = allData.filter(item => {
            const typeValid = !authorType || item.authorType === authorType;
            return typeValid;
        });

        initializeTable(filteredData);
    }

    function exportToExcel() {
        const filteredData = table.rows().data().toArray();
        
        const wsData = [
            ['Авторы', 'Название работы', 'Категория', 'Рейтинг', 'Уникальность'],
            ...filteredData.map(item => [
                item.author.join(', '),
                item.work_name,
                item.category,
                item.work_rating,
                item.uniquenes_score
            ])
        ];

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Научные работы");
        XLSX.writeFile(wb, 'scientific_works.xlsx');
    }
</script>
</html>