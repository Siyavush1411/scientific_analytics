<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль - ScienceHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
        }

        body {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            min-height: 100vh;
        }

        .profile-header {
            background: var(--primary-color);
            color: white;
            padding: 60px 0;
            text-align: center;
        }

        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid white;
            margin-bottom: 20px;
        }

        .profile-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            color: var(--primary-color);
            font-weight: bold;
        }

        .file-upload {
            border: 2px dashed var(--secondary-color);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .avatar-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .avatar-option.selected {
            border-color: var(--secondary-color);
            transform: scale(1.1);
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#" style="color: var(--primary-color);">
                <i class="bi bi-journal-bookmark-fill me-2"></i>ScienceHub
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item mx-2">
                        <a class="nav-link" href="./index.html">Главная</a>
                    </li>
                    <li class="nav-item mx-2">
                        <a class="nav-link" href="./index.html">О нас</a>
                    </li>
                    <li class="nav-item mx-2">
                        <a class="btn btn-secondary" href="./me.html">редактировать профиль</a>
                    </li>
                    <li class="nav-item mx-2">
                        <a class="btn btn-primary" href="./login.html">Выйти</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Шапка профиля -->
    <div class="profile-header">
        <div class="container">
            <img src="https://via.placeholder.com/150" alt="Аватар" class="profile-avatar" id="profileAvatar">
            <h2 id="profileName">Иван Иванов</h2>
            <p class="lead" id="profileEmail">ivan@example.com</p>
        </div>
    </div>


    <div class="container py-5">
        <div class="row g-4">
            <!-- Левая колонка -->
            <div class="col-lg-4">
                <!-- Аватар -->
                <div class="profile-card">
                    <h4><i class="bi bi-person-circle me-2"></i>Аватар</h4>
                    <div class="avatar-options">
                        <img src="https://via.placeholder.com/80" alt="Аватар 1" class="avatar-option">
                    </div>
                    <div class="mt-3">
                        <label for="avatarUpload" class="btn btn-secondary w-100">
                            <i class="bi bi-upload me-2"></i>Загрузить фото
                        </label>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                    </div>
                </div>

                <!-- Статистика -->
                <div class="profile-card">
                    <h4><i class="bi bi-bar-chart-line me-2"></i>Статистика</h4>
                    <div class="stat-card">
                        <h3>15</h3>
                        <p>Научных работ</p>
                    </div>
                    <div class="stat-card">
                        <h3>4.8</h3>
                        <p>Средний рейтинг</p>
                    </div>
                </div>
            </div>

            <!-- Правая колонка -->
            <div class="col-lg-8">
                
                <div class="profile-card">
                    <h4><i class="bi bi-file-earmark-arrow-up me-2"></i>Загрузка научных работ</h4>
                    
                    <!-- Поле для названия работы -->
                    <div class="mb-3">
                        <label for="workTitle" class="form-label">Название работы <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="workTitle" placeholder="Введите название научной работы" required>
                    </div>

                    <!-- Область загрузки файлов -->
                    <div class="file-upload" id="fileUploadArea">
                        <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                        <p class="mt-2">Перетащите файлы сюда или нажмите для загрузки</p>
                        <input type="file" id="fileInput" multiple style="display: none;">
                    </div>
                    <div class="mt-3" id="fileList"></div>
                    
                    <!-- Кнопка отправки -->
                    <button class="btn btn-primary mt-3" id="submitBtn">Отправить работу</button>
                </div>

                <!-- Последние работы -->
                <div class="profile-card">
                    <h4><i class="bi bi-journal-text me-2"></i>Последние работы</h4>
                    <ul class="list-group">
                        <li class="list-group-item">Работа 1</li>
                        <li class="list-group-item">Работа 2</li>
                        <li class="list-group-item">Работа 3</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script src="./js/doc_handler.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
     <script>
        document.addEventListener('DOMContentLoaded', function() {
            let accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');

            // Проверка авторизации
            if (accessToken != localStorage.getItem('access_token')) {
                window.location.href = './login.html';
                return;
            }

            // Функция обновления токена
            async function refreshAccessToken() {
                try {
                    const response = await fetch('http://127.0.0.1:8000/token/refresh/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ refresh: refreshToken })
                    });

                    if (!response.ok) throw new Error('Token refresh failed');
                    
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    accessToken = data.access;
                } catch (error) {
                    console.error('Ошибка обновления токена:', error);
                    window.location.href = './login.html';
                }
            }

            // Загрузка данных профиля
            async function loadProfile() {
                try {
                    let response = await fetch('http://127.0.0.1:8000/profile/', {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    // Если токен просрочен, пробуем обновить
                    if (response.status === 401) {
                        await refreshAccessToken();
                        response = await fetch('http://127.0.0.1:8000/profile/', {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                    }

                    const data = await response.json();

                    if (response.ok) {
                        document.getElementById('profileName').textContent = data.full_name;
                        document.getElementById('profileEmail').textContent = data.email;
                        document.getElementById('profileAvatar').src = data.avatar_url;
                    } else {
                        throw new Error(data.detail || 'Ошибка загрузки профиля');
                    }
                } catch (error) {
                    console.error('Ошибка:', error);
                    window.location.href = './login.html';
                }
            }

            // Обработка загрузки файлов
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', async () => {
                const files = fileInput.files;
                if (files.length === 0) return;

                const formData = new FormData();
                for (const file of files) {
                    formData.append('files', file);
                }

                try {
                    const response = await fetch('http://127.0.0.1:8000/upload/', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: formData
                    });

                    if (response.status === 401) {
                        await refreshAccessToken();
                        return fileInput.dispatchEvent(new Event('change'));
                    }

                    const result = await response.json();
                    console.log('Файлы загружены:', result);
                    alert('Файлы успешно загружены!');
                } catch (err) {
                    console.error('Ошибка загрузки:', err);
                    alert('Ошибка загрузки файлов');
                }
            });

            loadProfile();

            // Остальной код (аватары, UI взаимодействия)
            const avatarOptions = document.querySelectorAll('.avatar-option');
            avatarOptions.forEach(option => {
                option.addEventListener('click', function() {
                    avatarOptions.forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('profileAvatar').src = this.src;
                });
            });

            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileList = document.getElementById('fileList');

            fileUploadArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', function() {
                const files = Array.from(this.files);
                fileList.innerHTML = files.map(file => `
                    <div class="alert alert-secondary d-flex justify-content-between align-items-center">
                        <span>${file.name}</span>
                        <button class="btn btn-sm btn-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `).join('');
            });
        });

        function get_avatar_image(avatar) {
            
    </script>
</body>
</html>